# scDNA v1.1

The goal of scDNA R package is to provide a simple framework for
analyzing single cell DNA sequencing data. The current version primarily
focuses processing variant information on the Mission Bio Tapestri
platform. Functionality includes import of h5 files from Tapestri
pipeline, basic variant annotation, genotype extraction, clone
identification, and clonal trajectory inference. This package provides
wrappers for normalizing protein data for scDNA+Protein libraries for
downstream analysis.

## Installation

You can install (re-install) the current version (1.1) of scDNA below
This package is best suited for R \>=V4.3.1 and will function on
standard workstations. Typical install time should be less than 5
minutes. Average run time from beginning to end of analysis will vary by
sample size but should not exceed 30 minutes.

``` r
remotes::install_github("bowmanr/scDNA",force=TRUE)
```

## Version Updates

### **v1.1**

Version 1.1 is finally here with exciting new developments: - New
sequencing panels for variant annotation introduced: - hg38 - mm10  
- New plotting functions for RL trajectories. - new interactive plots, -
BSCITE-style implementation. - Demultiplexing samples is introduced -
(integrated and adapted from [Robinson et
al](https://www.biorxiv.org/content/10.1101/2022.09.20.508786v1.full),
[github](https://github.com/RobinsonTroy/scMRD)) - vignette included to
demonstrate how to perform it. - Cell confidence labeling based on DNA
and Protein data. - Outlier scores introduced for cell confidence. -
Stain index introduced for cell confidence. - Copy number variation
(CNV) and Ploidy analysis introduced. - Allele dropout assessment
introduced.

### **v1.0.1**

- H5 files are now read using the rhdf5 package and stored into a
  [SingleCellExperiment](https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html)
  container.

  - Merged h5 samples are identified and sample names are stored in
    colData(). Variant identification is ran separately and then merged.

  - Variant information is stored in rowData()

  - NGT matrix, clonal abundance, and clone architecture [familiar to
    previous versions](https://bowmanr.github.io/scDNA_myeloid/) can be
    found in the metadata.

- Variant identification and annotation is performed initially before
  reading in all the genotyping/QC data.

  - Transcript annotation matches [cannonical
    transcripts](https://docs.cbioportal.org/mutation-data-transcript-annotation/#transcript-assignment)
    used in the [cBio portal](https://www.cbioportal.org/).

  - To decrease variant location identification runtime, we created a
    custom TxDB object for the Clonal Evolution Panel from used
    [here](https://www.nature.com/articles/s41586-020-2864-x). If you
    have a different panel you can also use the [TxDB for hg19 from
    UCSC.](https://bioconductor.org/packages/release/data/annotation/html/TxDb.Hsapiens.UCSC.hg19.knownGene.html)
    Future versions will have local data for all panels from Mission
    Bio, as well as a simple script for generating a TxDB object for
    custom panels.

- Protein data is stored as an altExp() container within the container.

  - Wrappers for [DSB](https://github.com/niaid/dsb) and CLR
    normalization are provided. (CLR currently performed in
    [Seurat](https://satijalab.org/seurat/)).

  - Simple import into Seurat is demonstrated.

  - Export to FCS files with mutations and clone “completeness” provided
    as variables.

## Simple workflow

Identify all variants within a sample.

``` r
library(scDNA)
library(dplyr)
sample_file<- "test_file.h5"
variant_output<-variant_ID(file=sample_file,
                           panel="MSK_RL", # "UCSC" can be used for other panels
                           GT_cutoff=0,  # mimimum percent of cells where a successful genotyping call was made
                           VAF_cutoff=0) # mimimum variant allele frequency 
```

Identify mutations in genes of interest.

``` r
genes_of_interest <- c("IDH2","NRAS","NPM1","TET2","FLT3","IDH1")
variants_of_interest<-variant_output%>%
                          dplyr::filter(Class=="Exon")%>%
                          dplyr::filter(VAF>0.01)%>%
                          dplyr::filter(genotyping_rate>85)%>%
                          dplyr::filter(!is.na(CONSEQUENCE)&CONSEQUENCE!="synonymous")%>%
                          dplyr::filter(SYMBOL%in%genes_of_interest)%>%   
                          dplyr::arrange(desc(VAF))%>%
                          dplyr::slice(c(1:3)) # take the 3 most abundance mutations
```

Read in the data, enumerate clones, and compute statistics. Sample
statistics mirror that seen in Figure 1
[here](https://www.nature.com/articles/s41586-020-2864-x), and are
stored in the metadata.

``` r
sce<-tapestri_h5_to_sce(file=sample_file,variant_set = variants_of_interest)
sce<-enumerate_clones(sce)
sce<-compute_clone_statistics(sce,skip_ploidy=FALSE)
```

Simple function for producing a graph in the style of Figure 1D from
[here](https://www.nature.com/articles/s41586-020-2864-x),

``` r
clonograph(sce)
```

![](images/Screen%20Shot%202023-09-19%20at%2010.07.16%20PM.png)

Function to perform Reinforcment Learning / MDP approach for clonal
trajectory as in Figure 3
[here](https://www.nature.com/articles/s41586-020-2864-x),

``` r
sce<-trajectory_analysis(sce,use_ADO=TRUE)
```

Methods for protein normalization. Both dsb and CLR normalization can be
performed and stored in separate slots. We tend to have favor dsb so
far.

``` r
droplet_metadata<- extract_droplet_size(sce)
background_droplets<-droplet_metadata%>%
                          dplyr::filter(Droplet_type=="Empty")%>%
                          dplyr::filter(dna_size<1.5&dna_size>0.15)%>%
                          pull(Cell)

sce<-normalize_protein_data(sce=sce,
                             metadata=droplet_metadata,
                             method=c("dsb","CLR"),
                             detect_IgG=TRUE,
                             background_droplets=background_droplets)
```

### Developments in progress:

1.  Cohort summarization
2.  Creating custom TxDB objects

### Ongoing investigation:

1.  Improving cell identification and distinction from empty droplets.
    1.  Doublet and dead cell identification
2.  Improve normalization for protein data.
    1.  Improve cell type identification based on immunophenotype
3.  Improvements to the MDP and RL.

# Package index

## All functions

- [`BuildMDP()`](https://bowmanr.github.io/scDNA/reference/BuildMDP.md)
  : The main function builds an adjacency list of the theoretical order
  of mutations. The same MDP mask can be reused different mutations
- [`GetMembership()`](https://bowmanr.github.io/scDNA/reference/GetMembership.md)
  : Get membership quality of cells vs empty
- [`GetStainIndex()`](https://bowmanr.github.io/scDNA/reference/GetStainIndex.md)
  : Get Stain Index for cells
- [`add_cell_annotation()`](https://bowmanr.github.io/scDNA/reference/add_cell_annotation.md)
  : Title
- [`annotate_variants()`](https://bowmanr.github.io/scDNA/reference/annotate_variants.md)
  : Annotate variants of interest This function takes in h5 files to
  extract DNA information through given TXDB files (primarily hg19) The
  gene names are mapped for their specific nucleotide positions. The
  starting and ending positions for the chromosome are listed. The
  consequence of the mutation such as synonymous, nonsynonymous, as well
  as if this is a coding region, on the exon boundry or intronic. Short
  amino acid changes are also labeled. The variance matrix also extracts
  the amplicon that the variant is found on.
- [`attach_weights()`](https://bowmanr.github.io/scDNA/reference/attach_weights.md)
  : Assigns observed counts as weights to the Markov Decision Process
- [`cell_confidence_labeling()`](https://bowmanr.github.io/scDNA/reference/cell_confidence_labeling.md)
  : cell_confidence_labeling This function provides additional labeling
  to he quality of the cells based on dna and protein data.
- [`clonograph()`](https://bowmanr.github.io/scDNA/reference/clonograph.md)
  : Plotting clonographs
- [`compare_VAFs()`](https://bowmanr.github.io/scDNA/reference/compare_VAFs.md)
  : Title
- [`compute_clone_statistics()`](https://bowmanr.github.io/scDNA/reference/compute_clone_statistics.md)
  : Title
- [`demultiplex_samples()`](https://bowmanr.github.io/scDNA/reference/demultiplex_samples.md)
  : Demultiplex wrapper function to handle splitting samples
- [`enumerate_clones()`](https://bowmanr.github.io/scDNA/reference/enumerate_clones.md)
  : Enumerate clones
- [`extract_droplet_size()`](https://bowmanr.github.io/scDNA/reference/extract_droplet_size.md)
  : Extract protein library size, dna library size, and amplicon size
  for all droplets.
- [`fcs_export()`](https://bowmanr.github.io/scDNA/reference/fcs_export.md)
  : Title
- [`gemerate_txdb()`](https://bowmanr.github.io/scDNA/reference/gemerate_txdb.md)
  : Title
- [`get_own_path()`](https://bowmanr.github.io/scDNA/reference/get_own_path.md)
  : A way to navigate the MDP for any given starting root node to leaf
  node.
- [`impute_cluster()`](https://bowmanr.github.io/scDNA/reference/impute_cluster.md)
  : Title
- [`loom_to_sce()`](https://bowmanr.github.io/scDNA/reference/loom_to_sce.md)
  : Title
- [`match_clonal_graph()`](https://bowmanr.github.io/scDNA/reference/match_clonal_graph.md)
  : Title
- [`mdp_Q_learning_with_linklist()`](https://bowmanr.github.io/scDNA/reference/mdp_Q_learning_with_linklist.md)
  : This file run Reinforcement Learning (model-free Q-learning) to
  evaluate the most likely mutation paths from the data
- [`normalize_protein_data()`](https://bowmanr.github.io/scDNA/reference/normalize_protein_data.md)
  : Normalize Protein Data
- [`optimize_matrix()`](https://bowmanr.github.io/scDNA/reference/optimize_matrix.md)
  : Title
- [`quality_output()`](https://bowmanr.github.io/scDNA/reference/quality_output.md)
  : Produce long form quality metrics for each cell-variant pair for
  read depth, allele frequency, and genotype quality
- [`readDNA_CN_H5()`](https://bowmanr.github.io/scDNA/reference/readDNA_CN_H5.md)
  : This function generates the Copy Number by determining the ploidy of
  each mutation
- [`select_clones()`](https://bowmanr.github.io/scDNA/reference/select_clones.md)
  : Select clones of interest on the basis QC metrics
- [`tabulate_mutations()`](https://bowmanr.github.io/scDNA/reference/tabulate_mutations.md)
  : Title
- [`tapestri_h5_to_sce()`](https://bowmanr.github.io/scDNA/reference/tapestri_h5_to_sce.md)
  : Import Tapestri H5 data and extract genotype matrix
- [`trajectory_analysis()`](https://bowmanr.github.io/scDNA/reference/trajectory_analysis.md)
  : Run Trajectory Analysis after extraction from SingleCellExperiment
  object
- [`trajectory_of_interest_BSCITE_format()`](https://bowmanr.github.io/scDNA/reference/trajectory_of_interest_BSCITE_format.md)
  : BSCITE Style single trajectory Plot
- [`trajectory_of_interest_figure()`](https://bowmanr.github.io/scDNA/reference/trajectory_of_interest_figure.md)
  : Single Trajectory visualization of interest.
- [`variant_ID()`](https://bowmanr.github.io/scDNA/reference/variant_ID.md)
  : Variant identification and frequency tallies The DNA variants for
  each cell are pulled from the specified H5 files. Each variant for
  each cell is genotyped to be WildType, Heterozygous, Homozygous or
  Missing. The genotyping rate is determined by taking WT+Het+Hom over
  total cell calls (including missing). The VAF is determined by number
  of allele copies we see in a weighted sum. A filter is applied to both
  of these calculatins to include or exclude variants of interest. These
  are then annotated to include the variant information such as gene
  name, nucleotide location, and short amino acid changes.
- [`visualize_WT_dominant_clone()`](https://bowmanr.github.io/scDNA/reference/visualize_WT_dominant_clone.md)
  : Title
- [`visualize_all_WT_dominant_clone()`](https://bowmanr.github.io/scDNA/reference/visualize_all_WT_dominant_clone.md)
  : Title
- [`visualize_any_optimal_path()`](https://bowmanr.github.io/scDNA/reference/visualize_any_optimal_path.md)
  : Title
- [`visualize_full_network()`](https://bowmanr.github.io/scDNA/reference/visualize_full_network.md)
  : Visualize Full Network

# Articles

### All vignettes

- [scDNA: Example for demultiplexing
  samples](https://bowmanr.github.io/scDNA/articles/Demultiplex_vignette.md):
- [scDNA: R package for DNA+protein single cell DNA sequencing
  analysis](https://bowmanr.github.io/scDNA/articles/vignette.md):
